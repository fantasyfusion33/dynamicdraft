<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantasy Draft Board</title>
  <style>
    /* Modern Professional Design */
    :root {
      --primary: #D2042D;
      --dark: #0A0A0A;
      --light: #FFFFFF;
      --gray: #1A1A1A;
      --glass: rgba(26, 26, 26, 0.8);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--dark);
      color: var(--light);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .countdown-clock {
      position: fixed;
      top: 40px;
      left: calc(350px + 45px);
      width: 75px;
      font-size: 2rem;
      font-weight: 600;
      background: var(--glass);
      padding: 12px 20px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 300;
    }

    .sidebar.collapsed ~ .countdown-clock {
     left: 45px;
    }

    .draft-header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem 0;
      background: linear-gradient(135deg, var(--dark) 0%, #1a1a1a 100%);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    .draft-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(210, 4, 45, 0.1) 0%, rgba(210, 4, 45, 0.05) 100%);
    }

    .current-player {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--light);
      padding: 12px 24px;
      background: var(--primary);
      border-radius: 8px;
      display: inline-block;
      backdrop-filter: blur(10px);
      margin: 1rem 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .current-player span {
      font-weight: 400;
      color: rgba(255, 255, 255, 0.8);
    }

    .current-player strong {
      font-weight: 700;
    }

   .filters {
     display: flex;
     align-items: center;
     gap: 20px;
     margin-bottom: 20px;
     padding-left: 10px;
   }

   .search-bar {
     position: relative;
     flex: 1;
     max-width: 200px;
     min-width: 200px;
     margin-left: 10px;
   }

   #teamSearch {
     width: 80%;
     padding: 8px 30px 8px 12px;
     background: var(--gray);
     border: 1px solid rgba(255, 255, 255, 0.1);
     border-radius: 6px;
     color: var(--light);
     font-size: 14px;
   }

   .clear-search {
     position: absolute;
     right: 9px;
     top: 50%;
     transform: translateY(-50%);
     background: none;
     border: none;
     color: rgba(255, 255, 255, 0.5);
     cursor: pointer;
     padding: 0;
     font-size: 1.2rem;
   }

   .clear-search:hover {
     color: var(--primary);
   }

   .filters select {
     padding: 10px 16px;
     background: var(--gray);
     color: var(--light);
     border: 1px solid rgba(255, 255, 255, 0.1);
     border-radius: 8px;
     font-size: 14px;
     transition: all 0.2s ease;
   }

   .filters select:hover {
     border-color: var(--primary);
   }

    .team-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 2rem;
    }

    .team-card {
      background: var(--glass);
      padding: 20px;
      border-radius: 12px;
      position: relative;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      z-index: 200;
    }

    .team-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .team-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    .team-card.NFL { border-left: 4px solid #8A2BE2; }
    .team-card.NBA { border-left: 4px solid #FF69B4; }
    .team-card.MLB { border-left: 4px solid #4169E1; }
    .team-card.NHL { border-left: 4px solid #FFA500; }
    .team-card.NCAAF { border-left: 4px solid #32CD32; }
    .team-card.NCAAB { border-left: 4px solid #FFD700; }

    .team-card h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--light);
    }

    .team-card p {
      margin: 4px 0;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .team-card button {
      margin-top: 16px;
      width: 100%;
      padding: 10px;
      background: var(--primary);
      color: var(--light);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .team-card button:disabled {
      background: rgba(210, 4, 45, 0.3);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .team-card button:hover:not(:disabled) {
      background: #B00326;
      transform: translateY(-1px);
    }

    .flag {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 6px;
      right: 6px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 500;
      z-index: 1;
      line-height: 1.2;
      text-align: center;
    }

    .flag.in-season { background: rgba(0, 255, 0, 0.15); color: #00FF00; }
    .flag.off-season { background: rgba(255, 0, 0, 0.15); color: #FF4444; }

    .rosters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 2rem;
    }

    .roster {
      background: var(--glass);
      padding: 20px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
    }

    .roster h2 {
      margin: 0 0 16px;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--light);
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-transform: uppercase;
      letter-spacing: 1px;
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 6px;
    }

    .roster ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .roster li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin: 8px 0;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.03);
    }
    
    .roster li strong {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--light);
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 6px;
      display: block;
      margin: 8px 0;
    }

    .roster li:last-child {
      border-bottom: none;
    }

    .roster li.NFL { border-left: 4px solid #8A2BE2; }
    .roster li.NBA { border-left: 4px solid #FF69B4; }
    .roster li.MLB { border-left: 4px solid #4169E1; }
    .roster li.NHL { border-left: 4px solid #FFA500; }
    .roster li.NCAAF { border-left: 4px solid #32CD32; }
    .roster li.NCAAB { border-left: 4px solid #FFD700; }

    .draft-pick-circle {
      background: var(--primary);
      color: var(--light);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .draft-pick-circle.NFL { background: #8A2BE2; }
    .draft-pick-circle.NBA { background: #FF69B4; }
    .draft-pick-circle.MLB { background: #4169E1; }
    .draft-pick-circle.NHL { background: #FFA500; }
    .draft-pick-circle.NCAAF { background: #32CD32; }
    .draft-pick-circle.NCAAB { background: #FFD700; }

    .draft-status-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin: 20px 0;
      position: relative;
    }

    .draft-progress {
      height: 100%;
      background: var(--primary);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    @keyframes pulse-glow {
      0% { box-shadow: 0 0 0 0 rgba(210, 4, 45, 0.4); }
      100% { box-shadow: 0 0 0 6px rgba(210, 4, 45, 0); }
    }

    .urgent {
      animation: pulse-glow 1.5s infinite;
    }

    .draft-complete {
      margin: 0;
      padding: 20px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--dark);
    }

    .draft-complete-container {
      padding: 20px;
      overflow-y: auto;
      height: calc(100vh - 120px);
      scrollbar-width: none;
    }

    .draft-complete-container::-webkit-scrollbar {
      display: none;
    }

    .final-rosters {
      display: flex;
      justify-content: center;
      gap: 25px;
      width: 100%;
    }

    .final-rosters .roster {
      display: block;
      width: 350px;
      background: var(--glass);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .final-rosters .roster h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 350px;
      height: 100vh;
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
      z-index: 100;
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    .sidebar-toggle {
      position: fixed;
      top: 20px;
      left: 350px;
      background: var(--primary);
      color: var(--light);
      border: none;
      padding: 10px;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      transition: left 0.3s ease;
      z-index: 300;
    }

    .sidebar.collapsed + .sidebar-toggle {
      left: 0px;
    }

    .sidebar-toggle .arrow {
      font-size: 1.2rem;
      transition: transform 0.3s ease;
    }

    .sidebar.collapsed .sidebar-toggle .arrow {
      transform: rotate(180deg);
    }

    .team-selector {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .team-selector select {
      width: 100%;
      padding: 10px;
      background: var(--gray);
      color: var(--light);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .team-selector select:hover {
      border-color: var(--primary);
    }

   .roster-container {
     padding: 20px;
     overflow-y: auto;
     height: calc(100vh - 120px);
     scrollbar-width: none;
   }

   .roster-container::-webkit-scrollbar {
     display: none;
   }

    .roster {
      display: none;
    }

    .roster.active {
      display: block;
    }

    .main-content {
      margin-left: 350px;
      transition: margin-left 0.3s ease;
    }

    .sidebar.collapsed ~ .main-content {
      margin-left: 0;
    }

    .team-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primaryColor);
      position: relative;
      margin-right: 8px;
    }

    .team-icon i {
      font-size: 20px;
      color: var(--secondaryColor);
    }
    
    /* MyTeam Box */
    #myTeamBox {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 275px;
      height: 200px;
      background: #333;
      padding: 16px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 300;
      transition: transform 0.3s ease;
    }

    #myTeamBox.collapsed {
      transform: translateX(calc(100% - 40px));
    }

    #myTeamBox.collapsed #myTeamContent {
      display: none;
    }

    #toggleMyTeam {
      position: absolute;
      top: 10px;
      left: -38px;
      background: #D2042D;
      color: #FFF;
      border: none;
      padding: 8px 12px;
      border-radius: 6px 0 0 6px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #toggleMyTeam .arrow {
      transition: transform 0.3s ease;
    }

    #myTeamBox.collapsed #toggleMyTeam .arrow {
      transform: rotate(0deg);
    }

    #myTeamBox:not(.collapsed) #toggleMyTeam .arrow {
      transform: rotate(180deg);
    }

    .sport-grid {
      display: grid;
      margin-top: -10px;
      grid-template-columns: repeat(2, 1fr);
      gap: 1px;
    }

    .sport-slot h4 {
      margin: 0 0 0px;
      font-size: 14px;
      color: #FFF;
      text-align: center;
    }

    .sport-slot:nth-child(2n) {
      margin-top: 4px;
    }

    .slots {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    /* My Team Box Slots */
    .slot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: block;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
      position: relative;
    }

    .slot.filled {
      background: transparent;
    }

    /* Team Popup Styles */
    .team-popup {
      display: none;
      position: fixed;
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 16px;
      backdrop-filter: blur(10px);
      z-index: 300;
      width: 150px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .team-popup-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .team-popup-body p {
      margin: 4px 0;
      font-size: 0.9rem;
    }

    .wildcard-badge {
      display: inline-block;
      background: #FFD700;
      color: #000;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-left: 8px;
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .countdown-clock {
        top: 10px;
        left: 10px;
        font-size: 1.2rem;
        padding: 6px 12px;
        width: 60px;
      }

      .sidebar {
        width: 200px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.collapsed {
        transform: translateX(-100%);
      }

      .sidebar:not(.collapsed) ~ .main-content {
        margin-left: 200px;
      }

      .sidebar-toggle {
        top: 10px;
        left: 10px;
        padding: 6px;
        font-size: 1rem;
      }

      body {
        font-size: 14px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .team-card h3 {
        font-size: 1rem;
      }

      .team-card p {
        font-size: 0.8rem;
      }

      .team-list {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .sidebar:not(.collapsed) ~ .main-content .team-list {
        grid-template-columns: repeat(2, 1fr);
      }

      .team-card {
        padding: 10px;
      }

      #myTeamBox {
        display: none;
      }

      .team-popup {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 300px;
        background: var(--glass);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 15px;
        backdrop-filter: blur(10px);
        z-index: 1000;
      }

      .team-card {
        cursor: pointer;
      }

      .filters {
        display: grid;
        grid-template-rows: auto auto;
        gap: 10px;
        margin-bottom: 15px;
      }

      .filters > .search-bar {
        grid-row: 1;
        grid-column: 1 / span 2;
        max-width: none;
      }

      .filters > #sortBy {
        grid-row: 1;
        grid-column: 3;
        width: 100%;
      }

      .filters > #sportFilter,
      .filters > #seasonFilter {
        grid-row: 2;
        width: 100%;
      }

      .filters > #sportFilter {
        grid-column: 1 / span 2;
      }

      .filters > #seasonFilter {
        grid-column: 3;
      }

      .search-bar,
      .filters select {
        width: 100%;
        max-width: none;
        font-size: 14px;
        padding: 8px;
      }

      .clear-search {
        right: 8px;
        font-size: 1rem;
      }
    }

  </style>
</head>
<body>
<div class="main-content">
<div id="myTeamBox" class="collapsed">
  <button id="toggleMyTeam" onclick="toggleMyTeam()">
    <span class="arrow">◀</span>
  </button>
  <div id="myTeamContent">
    <div class="sport-grid">
    <h3 id="myTeamName">My Team</h3>
<div class="sport-slot" data-sport="NFL">
  <h4>NFL</h4>
  <div class="slots">
    <div class="slot"></div>
    <div class="slot"></div>
  </div>
</div>
<div class="sport-slot" data-sport="NBA">
  <h4>NBA</h4>
  <div class="slots">
    <div class="slot"></div>
    <div class="slot"></div>
  </div>
</div>
<div class="sport-slot" data-sport="MLB">
  <h4>MLB</h4>
  <div class="slots">
    <div class="slot"></div>
    <div class="slot"></div>
  </div>
</div>
<div class="sport-slot" data-sport="NHL">
  <h4>NHL</h4>
  <div class="slots">
    <div class="slot"></div>
    <div class="slot"></div>
  </div>
</div>
<div class="sport-slot" data-sport="NCAAF">
  <h4>NCAA Football</h4>
  <div class="slots">
    <div class="slot"></div>
    <div class="slot"></div>
  </div>
</div>
<div class="sport-slot" data-sport="NCAAB">
  <h4>NCAA Basketball</h4>
  <div class="slots">
    <div class="slot"></div>
    <div class="slot"></div>
  </div>
</div>
<div class="sport-slot" data-sport="Wildcard">
  <h4>Wildcard</h4>
  <div class="slots">
    <div class="slot"></div>
  </div>
</div>
    </div>
  </div>
</div>  
<div class="draft-header">
    <h1 id="draftTitle">Fantasy Fusion Draft</h1>
    <div class="current-player" id="currentPlayerBox">
      <span>On The Clock:</span> <strong>Loading...</strong>
    </div>
  </div>
  <div class="draft-status-bar">
    <div class="draft-progress" style="width: 0%"></div>
  </div>
  <div id="app">
    <div class="filters">
  <div class="search-bar">
    <input type="text" id="teamSearch" placeholder="Search for teams...">
    <button id="clearSearch" class="clear-search">&times;</button>
  </div>
  <label>Sort By:</label>
  <select id="sortBy">
    <option value="championship_odds">Odds</option>
    <option value="adp">ADP</option>
    <option value="lastYearPoints">Prev. Pts</option>
    <option value="championshipPct">% Odds</option>
  </select>
  <label>Filter:</label>
  <select id="seasonFilter">
    <option value="all">All</option>
    <option value="in-season">In Season</option>
    <option value="off-season">Off Season</option>
  </select>
  <select id="sportFilter">
    <option value="all">All Sports</option>
    <option value="NFL">NFL</option>
    <option value="NBA">NBA</option>
    <option value="MLB">MLB</option>
    <option value="NHL">NHL</option>
    <option value="NCAAF">NCAA Football</option>
    <option value="NCAAB">NCAA Basketball</option>
  </select>
  <select id="conferenceFilter" disabled>
    <option value="all">All Conferences</option>
  </select>
    </div>
    <div class="team-list" id="teamList">
      <!-- Teams will be dynamically inserted here -->
    </div>
  </div>
</div>
<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="team-selector">
    <select id="teamSelector" onchange="switchRoster(this.value)">
      <!-- Team options will be dynamically generated here -->
    </select>
  </div>
  <div class="roster-container">
    <!-- Rosters will be dynamically generated here -->
  </div>
</div>
</div>

<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle" onclick="toggleSidebar()">
  <span class="arrow">&#9664;</span>
</button>  
<div class="countdown-clock" id="countdownClock">02:00</div>

<div id="teamPopup" class="team-popup">
  <div class="team-popup-content">
    <div class="team-popup-body">
      <p><strong>ADP:</strong> <span id="popupTeamADP"></span></p>
      <p><strong>Odds:</strong> +<span id="popupTeamOdds"></span></p>
      <p><strong>Last Year's Points:</strong> <span id="popupTeamPoints"></span></p>
      <p><strong>Championship %:</strong> <span id="popupTeamChampionshipPct"></span>%</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
<script>

// Initialize Supabase client
const supabaseUrl = 'https://rbumhlgjljzcwaosefif.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidW1obGdqbGp6Y3dhb3NlZmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAyNTQxMTYsImV4cCI6MjA1NTgzMDExNn0.wC53zINy4iyxOzMfmqN9xw6Z2-bIjFMblXY95bS3kOQ';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Global variables for league settings
let leagueName, teamNames, teamCount, wildcard, userTeamPosition;
let DraftableTeams = [];
let draftState = null;
let leagueId = null;

// Get league ID from URL
const urlParams = new URLSearchParams(window.location.search);
leagueId = urlParams.get('leagueId');

// Fetch league data from Supabase
async function fetchLeagueData(leagueId) {
  try {
    const { data, error } = await supabase
      .from('mock_drafts')
      .select('*')
      .eq('id', leagueId)
      .single();

    if (error) throw error;

    // Set global variables
    leagueName = data.league_name;
    teamNames = data.team_names || [];
    teamCount = data.team_count;
    wildcard = data.wildcard_round;
    userTeamPosition = data.user_team_position || 0;

    return data;
  } catch (err) {
    console.error('Error fetching league data:', err);
    alert('Failed to fetch league data. Please try again.');
    return null;
  }
}

// Initialize draft state
function initializeDraftState(leagueData) {
  // Calculate total picks
  const totalPicks = teamCount * (wildcard ? 13 : 12);
  
  draftState = {
    currentPick: leagueData.current_pick || 0,
    draftOrder: leagueData.draft_order || generateDraftOrder(),
    playerRosters: leagueData.player_rosters || initializePlayerRosters(),
    totalPicks: totalPicks,
    timer: null
  };
}

// Initialize player rosters
function initializePlayerRosters() {
  const playerRosters = {};
  for (let i = 1; i <= teamCount; i++) {
    playerRosters[i] = {
      NFL: [],
      NBA: [],
      MLB: [],
      NHL: [],
      NCAAF: [],
      NCAAB: [],
      wildcard: []
    };
  }
  return playerRosters;
}

// Generate draft order
function generateDraftOrder() {
  const order = [];
  const totalRounds = wildcard ? 13 : 12;
  
  for (let round = 1; round <= totalRounds; round++) {
    const roundOrder = round % 2 === 1 ? 
      Array.from({ length: teamCount }, (_, i) => i + 1) : 
      Array.from({ length: teamCount }, (_, i) => teamCount - i);
    order.push(...roundOrder);
  }
  return order;
}

// Save draft progress
async function saveDraftProgress() {
  try {
    const { error } = await supabase
      .from('mock_drafts')
      .update({
        current_pick: draftState.currentPick,
        player_rosters: draftState.playerRosters,
        status: draftState.currentPick >= draftState.totalPicks ? 'completed' : 'active',
        completed_at: draftState.currentPick >= draftState.totalPicks ? new Date().toISOString() : null
      })
      .eq('id', leagueId);

    if (error) throw error;
  } catch (err) {
    console.error('Error saving draft progress:', err);
  }
}

// Update draft header
function updateDraftHeader() {
  if (!draftState) return;
  
  const currentPlayer = draftState.draftOrder[draftState.currentPick];
  const round = Math.floor(draftState.currentPick / teamCount) + 1;
  const isWildcardRound = round === 13 && wildcard;
  const pick = (draftState.currentPick % teamCount) + 1;
  const teamName = teamNames[currentPlayer - 1];

  document.getElementById('currentPlayerBox').innerHTML = `
    <span>On The Clock:</span>
    <strong>${teamName} - ${isWildcardRound ? 
      'Wildcard Round' : `Round ${Math.min(round, 13)}.${pick}`}
    </strong>
  `;
}

// Create team sidebar
function createTeamSidebar() {
  const sidebar = document.getElementById('sidebar');
  const rosterContainer = document.querySelector('.roster-container');
  rosterContainer.innerHTML = '';

  // Populate team selector
  const teamSelector = document.getElementById('teamSelector');
  teamSelector.innerHTML = teamNames
    .map((name, index) => `<option value="player${index + 1}">${name}</option>`)
    .join('');
  
  // Generate team sections
  for (let i = 1; i <= teamCount; i++) {
    const roster = document.createElement('div');
    roster.className = `roster ${i === 1 ? 'active' : ''}`;
    roster.id = `player${i}Roster`;
    const teamName = teamNames[i - 1];
    
    roster.innerHTML = `
      <h2>${teamName}</h2>
      <ul id="player${i}Teams">
        ${Object.keys(draftState.playerRosters[i])
          .filter(k => k !== 'wildcard')
          .map(sport => `
            <strong>${sport}</strong>
            ${draftState.playerRosters[i][sport].map(t => `
              <li class="${t.sport}">
                ${t.name}
                <div class="draft-pick-circle ${t.sport}">
                  ${t.round}.${t.pick}
                </div>
              </li>
            `).join('')}
            ${Array(2 - draftState.playerRosters[i][sport].length).fill('<li class="empty">Empty</li>').join('')}
          `).join('')}
        ${wildcard ? `
          <strong>Wildcard</strong>
          ${draftState.playerRosters[i].wildcard.map(t => `
            <li class="${t.sport}">
              ${t.name}
              <div class="draft-pick-circle ${t.sport}">
                ${t.round}.${t.pick}
              </div>
            </li>
          `).join('')}
          ${Array(1 - draftState.playerRosters[i].wildcard.length).fill('<li class="empty">Empty</li>').join('')}
        ` : ''}
      </ul>
    `;
    rosterContainer.appendChild(roster);
  }
}

// Switch roster to current player
function switchRosterToCurrentPlayer() {
  const currentPlayerNumber = draftState.draftOrder[draftState.currentPick];
  const teamSelector = document.getElementById('teamSelector');
  teamSelector.value = `player${currentPlayerNumber}`;
  switchRoster(`player${currentPlayerNumber}`);
}

// Switch roster display
function switchRoster(team) {
  const rosters = document.querySelectorAll('.roster');
  rosters.forEach(roster => roster.style.display = 'none');
  
  const activeRoster = document.getElementById(`${team}Roster`);
  if (activeRoster) {
    activeRoster.style.display = 'block';
  }
}

// Toggle sidebar
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('collapsed');
  
  const mainContent = document.querySelector('.main-content');
  mainContent.style.marginLeft = sidebar.classList.contains('collapsed') ? '0' : '350px';
  
  const arrow = document.querySelector('.sidebar-toggle .arrow');
  arrow.innerHTML = sidebar.classList.contains('collapsed') ? '&#9654;' : '&#9664;';
}

// Toggle My Team box
function toggleMyTeam() {
  const myTeamBox = document.getElementById('myTeamBox');
  myTeamBox.classList.toggle('collapsed');
}

// Start countdown timer
function startCountdown() {
  if (draftState.timer) {
    clearInterval(draftState.timer);
  }
  
  let timeLeft = 120;
  const timerElement = document.getElementById('countdownClock');
  
  draftState.timer = setInterval(() => {
    timeLeft--;
    timerElement.textContent = `${String(Math.floor(timeLeft/60)).padStart(2,'0')}:${String(timeLeft%60).padStart(2,'0')}`;
    
    if (timeLeft <= 0) {
      clearInterval(draftState.timer);
      autoDraftTeam();
    }
  }, 1000);
}

// Get sport icon
function getSportIcon(team) {
  switch (team.sport) {
    case "NBA":
    case "NCAAB":
      return `<i class="fa-solid fa-basketball" style="color: ${team.secondaryColor};"></i>`;
    case "NFL":
    case "NCAAF":
      return `<i class="fa-solid fa-football" style="color: ${team.secondaryColor};"></i>`;
    case "MLB":
      return `<i class="fa-solid fa-baseball" style="color: ${team.secondaryColor};"></i>`;
    case "NHL":
      return `<i class="fa-solid fa-hockey-puck" style="color: ${team.secondaryColor};"></i>`;
    default:
      return "";
  }
}

// Load team data
function loadTeamData() {
  Papa.parse("SportTeamDatabase_rows.csv", {
    download: true,
    header: true,
    dynamicTyping: true,
    complete: function (results) {
      DraftableTeams = results.data || [];
      renderTeams();
    },
    error: function (error) {
      console.error('Error loading CSV file:', error);
    }
  });
}

// Render teams
function renderTeams() {
  if (!DraftableTeams.length) return;
  
  const filter = document.getElementById('seasonFilter').value;
  const sport = document.getElementById('sportFilter').value;
  const sortKey = document.getElementById('sortBy').value || 'championship_odds';
  
  // Filter teams
  const filteredTeams = DraftableTeams.filter(team => {
    const isCurrentSeason = String(team.season_year || "").startsWith('2024');
    const isNextSeason = String(team.season_year || "").startsWith('2025');
    
    let seasonMatch = true;
    if (filter === "in-season") seasonMatch = isCurrentSeason;
    if (filter === "off-season") seasonMatch = isNextSeason;

    const matchesSport = sport === "all" || team.sport === sport;
    const matchesSearch = team.name.toLowerCase().includes(document.getElementById('teamSearch').value.toLowerCase());
    
    return seasonMatch && matchesSport && matchesSearch;
  });

  // Sort teams
  const sortedTeams = filteredTeams.sort((a, b) => {
    const aHasOdds = a.championshipPct > 0;
    const bHasOdds = b.championshipPct > 0;
    if (aHasOdds && !bHasOdds) return -1;
    if (!aHasOdds && bHasOdds) return 1;
    
    const propMap = {
      "championship_odds": "championship_odds",
      "adp": "adp",
      "lastYearPoints": "lastYearPoints",
      "championshipPct": "championshipPct"
    };
    
    const property = propMap[sortKey] || "championship_odds";
    if (typeof a[property] === "undefined") return 1;
    if (typeof b[property] === "undefined") return -1;
    
    const direction = property === "lastYearPoints" || property === "championshipPct" ? -1 : 1;
    return (a[property] - b[property]) * direction;
  });

  // Render team list
  const teamList = document.getElementById('teamList');
  teamList.innerHTML = '';
  
  sortedTeams.forEach(team => {
    const teamCard = document.createElement('div');
    teamCard.className = `team-card ${team.sport}`;
    teamCard.dataset.teamId = team.team_id;
    
    teamCard.innerHTML = `
      <div class="flag ${String(team.season_year || "").startsWith("2024") ? 'in-season' : 'off-season'}">
        ${String(team.season_year || "").startsWith("2024") ? 'In Season' : 'Off Season'}
      </div>
      <div class="team-card-header">
        <div class="team-icon ${team.sport}" 
             style="--primaryColor: ${team.primaryColor}; 
                    --secondaryColor: ${team.secondaryColor}"> 
          ${getSportIcon(team)}
        </div>
        <h3>${team.name}</h3>
      </div>
      <p>${team.sport} (${team.season_year})</p>
      <p>${team.conference || team.league} ${team.division ? `${team.division}` : ''}</p>
      <p>${getDynamicInfo(team, sortKey)}</p>
      <button onclick="draftTeam('${team.team_id}')">Draft</button>
    `;
    
    teamCard.addEventListener('mouseenter', handleTeamHover);
    teamCard.addEventListener('mouseleave', handleTeamLeave);
    teamList.appendChild(teamCard);
  });
}

// Get dynamic info for team card
function getDynamicInfo(team, sortKey) {
  const formats = {
    championship_odds: v => `Odds: +${v}`,
    adp: v => `ADP: ${v}`,
    lastYearPoints: v => `Prev: ${v} Pts`,
    championshipPct: v => `% Odds: ${v.toFixed(1)}%`
  };
  
  const value = team[sortKey] ?? 0;
  const formatter = formats[sortKey] || formats.championship_odds;
  return formatter(value);
}

// Handle team hover for popup
function handleTeamHover(e) {
  const teamCard = e.currentTarget;
  const teamId = teamCard.dataset.teamId;
  const team = DraftableTeams.find(t => t.team_id === teamId);
  
  if (team) {
    positionPopup(e, team);
    document.getElementById('teamPopup').style.display = 'block';
  }
}

// Handle team leave
function handleTeamLeave() {
  document.getElementById('teamPopup').style.display = 'none';
}

// Position popup
function positionPopup(e, team) {
  const { clientX, clientY } = e;
  const popup = document.getElementById('teamPopup');
  
  let left = clientX + 20;
  let top = clientY - 50;
  
  if (left + popup.offsetWidth > window.innerWidth) {
    left = window.innerWidth - popup.offsetWidth - 10;
  }
  
  if (top + popup.offsetHeight > window.innerHeight) {
    top = window.innerHeight - popup.offsetHeight - 10;
  }
  
  popup.style.left = `${left}px`;
  popup.style.top = `${top}px`;
  
  document.getElementById('popupTeamADP').textContent = team.adp;
  document.getElementById('popupTeamOdds').textContent = team.championship_odds;
  document.getElementById('popupTeamPoints').textContent = team.lastYearPoints;
  document.getElementById('popupTeamChampionshipPct').textContent = team.championshipPct;
}

// Auto-draft team
function autoDraftTeam() {
  if (!draftState) return;
  
  const pickIndex = draftState.currentPick;
  const playerIndex = draftState.draftOrder[pickIndex];
  const isWildcardRound = Math.floor(pickIndex / teamCount) + 1 === 13;
  const roster = draftState.playerRosters[playerIndex];
  
  // Filter eligible teams
  const eligibleTeams = DraftableTeams.filter(team => {
    const odds = parseFloat(team.championship_odds);
    if (isNaN(odds) || odds <= 0) return false;
    
    return (isWildcardRound && wildcard) || roster[team.sport]?.length < 2;
  });
  
  // Sort by odds
  const sortedTeams = eligibleTeams.sort((a, b) => {
    const aOdds = parseFloat(a.championship_odds);
    const bOdds = parseFloat(b.championship_odds);
    return aOdds - bOdds || a.name.localeCompare(b.name);
  });
  
  // Draft the team with lowest odds
  if (sortedTeams.length > 0) {
    draftTeam(sortedTeams[0].team_id);
  } else {
    advanceDraft();
  }
}

// Draft a team
function draftTeam(teamId) {
  if (!draftState) return;
  
  const pickIndex = draftState.currentPick;
  const playerIndex = draftState.draftOrder[pickIndex];
  const isWildcardRound = Math.floor(pickIndex / teamCount) + 1 === 13;
  const roster = draftState.playerRosters[playerIndex];
  
  // Find team
  const teamIndex = DraftableTeams.findIndex(t => t.team_id === teamId);
  if (teamIndex === -1) {
    alert('Team not found. Please try again.');
    return;
  }
  
  const team = DraftableTeams[teamIndex];
  
  // Check if team can be drafted
  if (isWildcardRound && wildcard) {
    roster.wildcard.push({
      ...team,
      round: Math.floor(pickIndex / teamCount) + 1,
      pick: (pickIndex % teamCount) + 1
    });
  } else {
    if (roster[team.sport].length >= 2) {
      alert(`Maximum 2 ${team.sport} teams allowed!`);
      return;
    }
    roster[team.sport].push({
      ...team,
      round: Math.floor(pickIndex / teamCount) + 1,
      pick: (pickIndex % teamCount) + 1
    });
  }
  
  // Remove team from available pool
  DraftableTeams.splice(teamIndex, 1);
  
  // Update UI
  updateRosterDisplay(playerIndex);
  if (playerIndex === userTeamPosition + 1) {
    updateMyTeamBox(team);
  }
  
  // Save and advance
  saveDraftProgress().then(advanceDraft);
}

// Update roster display
function updateRosterDisplay(playerIndex) {
  const roster = draftState.playerRosters[playerIndex];
  const rosterList = document.getElementById(`player${playerIndex}Teams`);
  
  if (!rosterList) return;
  
  let rosterHTML = Object.entries(roster)
    .filter(([sport]) => sport !== 'wildcard')
    .map(([sport, teams]) => `
      <strong>${sport}</strong>
      ${teams.map(team => `
        <li class="${team.sport}">
          ${team.name}
          <div class="draft-pick-circle ${team.sport}">
            ${team.round}.${team.pick}
          </div>
        </li>
      `).join('')}
      ${Array(2 - teams.length).fill('<li class="empty">Empty</li>').join('')}
    `).join('');
  
  // Add wildcard slot if enabled
  if (wildcard) {
    rosterHTML += `
      <strong>Wildcard</strong>
      ${roster.wildcard.map(team => `
        <li class="${team.sport}">
          ${team.name}
          <div class="draft-pick-circle ${team.sport}">
            ${team.round}.${team.pick}
          </div>
        </li>
      `).join('')}
      ${Array(1 - roster.wildcard.length).fill('<li class="empty">Empty</li>').join('')}
    `;
  }
  
  rosterList.innerHTML = rosterHTML;
}

// Update My Team Box
function updateMyTeamBox(team) {
  const sportContainer = document.querySelector(`.sport-slot[data-sport="${team.sport}"]`);
  const wildcardContainer = document.querySelector(`.sport-slot[data-sport="Wildcard"]`);
  const container = draftState.currentPick >= (12 * teamCount) ? wildcardContainer : sportContainer;
  
  if (!container) return;
  
  // Find the first empty slot
  const emptySlot = container.querySelector('.slot:not(.filled)');
  if (!emptySlot) return;
  
  // Create team icon element
  const teamIcon = document.createElement('div');
  teamIcon.className = `team-icon ${team.sport}`;
  teamIcon.style.setProperty('--primaryColor', team.primaryColor);
  teamIcon.style.setProperty('--secondaryColor', team.secondaryColor);
  teamIcon.innerHTML = getSportIcon(team);
  
  // Replace empty slot content
  emptySlot.innerHTML = '';
  emptySlot.classList.add('filled');
  emptySlot.appendChild(teamIcon);
}

// Advance draft
function advanceDraft() {
  if (!draftState) return;
  
  draftState.currentPick++;
  
  // Check if draft is complete
  if (draftState.currentPick >= draftState.totalPicks) {
    endDraft();
    return;
  }
  
  // Show wildcard message if needed
  if (draftState.currentPick === 12 * teamCount && wildcard) {
    alert("You have made it to the Wild Card round! You will now draft 1 final team that can be from any sport.");
  }
  
  // Update UI
  updateDraftHeader();
  updateDraftProgress();
  startCountdown();
  switchRosterToCurrentPlayer();
}

// Update draft progress bar
function updateDraftProgress() {
  if (!draftState) return;
  
  const progress = (draftState.currentPick / draftState.totalPicks) * 100;
  document.querySelector('.draft-progress').style.width = `${progress}%`;
}

// End draft
async function endDraft() {
  if (!draftState) return;
  
  // Save final state
  await saveDraftProgress();
  
  // Clear timer
  clearInterval(draftState.timer);
  
  // Remove UI elements
  ['#sidebar', '.sidebar-toggle', '.draft-header', '.countdown-clock', 
   '.draft-status-bar', '.team-popup', '#myTeamBox', '#toggleMyTeam'].forEach(selector => {
    const el = document.querySelector(selector);
    if (el) el.remove();
  });
  
  // Adjust main content
  const mainContent = document.querySelector(".main-content");
  if (mainContent) {
    mainContent.style.marginLeft = "auto";
    mainContent.style.marginRight = "auto";
  }
  
  // Build final rosters
  let rostersHTML = '';
  for (let i = 1; i <= teamCount; i++) {
    const roster = draftState.playerRosters[i];
    const teamName = teamNames[i - 1];
    
    rostersHTML += `
      <div class="roster">
        <h2>${teamName}</h2>
        <ul>
          ${Object.entries(roster)
            .filter(([sport]) => sport !== 'wildcard')
            .map(([sport, teams]) => `
              <strong>${sport}</strong>
              ${teams.map(team => `
                <li class="${team.sport}">
                  <div class="team-icon ${team.sport}" 
                       style="--primaryColor: ${team.primaryColor}; 
                              --secondaryColor: ${team.secondaryColor}"> 
                    ${getSportIcon(team)}
                  </div>
                  ${team.name}
                  <div class="draft-pick-circle ${team.sport}">
                    ${team.round}.${team.pick}
                  </div>
                </li>
              `).join('')}
              ${Array(2 - teams.length).fill('<li class="empty">Empty</li>').join('')}
            `).join('')}
          ${roster.wildcard?.length > 0 ? `
            <strong>Wildcard</strong>
            ${roster.wildcard.map(team => `
              <li class="${team.sport}">
                <div class="team-icon ${team.sport}" 
                     style="--primaryColor: ${team.primaryColor}; 
                            --secondaryColor: ${team.secondaryColor}"> 
                  ${getSportIcon(team)}
                </div>
                ${team.name}
                <div class="draft-pick-circle ${team.sport}">
                  ${team.round}.${team.pick}
                </div>
              </li>
            `).join('')}
          ` : ''}
        </ul>
      </div>
    `;
  }
  
  // Update app content
  const app = document.getElementById('app');
  if (app) {
    app.innerHTML = `
      <div class="draft-complete">
        <h2 style="text-align: center; margin-bottom: 30px;">
          Draft Complete! Here are your league's final rosters below:
        </h2>
        <div class="final-rosters">
          ${rostersHTML}
        </div>
      </div>
    `;
  }
}

// Initialize app
document.addEventListener('DOMContentLoaded', async () => {
  // Fetch league data
  const leagueData = await fetchLeagueData(leagueId);
  if (!leagueData) return;
  
  // Initialize draft state
  initializeDraftState(leagueData);
  
  // Set up UI
  document.getElementById('draftTitle').textContent = 
    `${leagueName} Draft - ${teamCount} Teams`;
  
  document.getElementById('myTeamName').textContent = 
    `${teamNames[userTeamPosition]}'s Team`;
  
  updateDraftHeader();
  createTeamSidebar();
  startCountdown();
  
  // Load team data and set up event listeners
  loadTeamData();
  
  // Set up filter event listeners
  document.getElementById('seasonFilter').addEventListener('change', renderTeams);
  document.getElementById('sportFilter').addEventListener('change', renderTeams);
  document.getElementById('sortBy').addEventListener('change', renderTeams);
  document.getElementById('teamSearch').addEventListener('input', renderTeams);
  
  document.getElementById('clearSearch').addEventListener('click', () => {
    document.getElementById('teamSearch').value = '';
    renderTeams();
  });
});

</script>
</body>
</html>
