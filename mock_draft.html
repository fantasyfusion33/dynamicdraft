<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Fusion - Mock Draft</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
        :root {
            --primary: #FA4616;
            --dark: #0C2340;
            --light: #FFFFFF;
            --gray: #1A1A1A;
            --glass: rgba(26, 26, 26, 0.8);
            /* Sport Colors */
            --nfl-color: #00338D;
            --nba-color: #FF671F;
            --mlb-color: #009688;
            --nhl-color: #8E44AD;
            --ncaaf-color: #D32F2F;
            --ncaab-color: #FBC02D;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--gray); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--dark);
            color: var(--light);
            margin: 0;
            padding: 20px;
        }
        .draft-container {
            display: grid;
            grid-template-areas: "header" "ticker" "main";
            grid-template-columns: 1fr;
            gap: 20px;
            max-width: 1600px;
            margin: auto;
            position: relative; /* Needed for help icon positioning */
        }
        .desktop-sidebar-area { display: none; }
        .draft-header { grid-area: header; position: relative; padding: 10px 0; }
        .draft-flow-tracker { grid-area: ticker; }
        .main-content { grid-area: main; }

        .site-brand {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }
        .league-title { text-align: center; margin: 0; font-size: 2.5rem; color: var(--light); }
        
        .countdown-clock {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            flex-shrink: 0;
            margin-left: 20px;
        }

        .draft-flow-tracker { display: flex; justify-content: space-between; align-items: center; background: var(--glass); padding: 15px; border-radius: 12px; gap: 15px; }
        .flow-pick-container { display: flex; flex-grow: 1; justify-content: space-around; gap: 15px;}
        .flow-pick { flex: 1; text-align: center; padding: 10px; border-radius: 8px; transition: all 0.3s ease; }
        .flow-pick h4 { margin: 0 0 8px 0; font-size: 0.8rem; text-transform: uppercase; color: rgba(255, 255, 255, 0.5); }
        .flow-pick p { margin: 0; font-weight: 600; font-size: 1.1rem; line-height: 1.3; }
        .flow-pick.on-the-clock { background: var(--primary); transform: scale(1.05); }
        .flow-pick .round-pick-info { font-size: 0.9rem; font-weight: 400; opacity: 0.8; }

        .draft-status-bar { height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; margin-bottom: 20px;}
        .draft-progress { height: 100%; width: 0%; background: var(--primary); transition: width 0.5s ease-out; }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--dark);
            padding: 10px 0;
        }

        .filters { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .filters .search-bar { flex-grow: 1; max-width: 400px; position: relative; }
        #teamSearch {
            padding: 10px 15px;
            background: var(--gray);
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            transition: background 0.2s;
            width: 100%; 
            box-sizing: border-box; 
            padding-right: 40px;
        }
        #teamSearch:hover { background: #2a2a2a; }
        .filters select, #teamSelector, #mobileTeamSelector {
            padding: 10px 15px;
            background: var(--gray);
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            transition: background 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .filters select:hover, #teamSelector:hover, #mobileTeamSelector:hover { background: #2a2a2a; }
        #clearSearch { position: absolute; right: 0; top: 0; bottom: 0; background: none; border: none; color: #888; font-size: 1.2rem; cursor: pointer; padding: 0 12px; }

        .table-container { overflow: auto; }
        .draft-table { width: 100%; border-collapse: separate; border-spacing: 0;}
        .draft-table th, .draft-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #333; white-space: nowrap; }
        .draft-table th { cursor: pointer; user-select: none; position: sticky; top: 0; background: var(--dark); z-index: 2;}
        .draft-table th:hover { background: var(--gray); }
        .draft-table th .sort-indicator { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; width: 1em; }
        .draft-table th.sort-active .sort-indicator { opacity: 1; }
        .draft-table tr:hover { background: var(--gray); }
        .draft-table .team-name-cell { display: flex; align-items: center; gap: 15px; white-space: normal; }
        .draft-table .team-sub-info {  font-size: 0.8rem; color: #aaa; display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .draft-table .sport-badge { padding: 3px 8px; border-radius: 12px; color: white; font-size: 0.8rem; font-weight: bold; }
        .draft-table .draft-button { 
            background: var(--primary); 
            border: none; 
            color: white; 
            padding: 8px 0; /* Vertical padding only */
            width: 80px; /* Fixed width */
            text-align: center;
            border-radius: 6px; 
            cursor: pointer; 
            transition: background-color 0.2s ease, font-size 0.2s ease; 
        }
        .draft-table .draft-button.confirm-state {
            background-color: #28a745; /* Green for confirm state */
        }
        .draft-table .draft-button:disabled { background: #555; cursor: not-allowed; }
        
        .roster ul { list-style: none; padding: 0; }
        .roster li { display: flex; align-items: center; gap: 10px; padding: 8px; margin-bottom: 5px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        .team-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .team-icon i { font-size: 14px; }
        .draft-pick-circle { margin-left: auto; width: 36px; height: 24px; font-size: 0.8em; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .draft-pick-circle.NFL, .sport-badge.NFL { background-color: var(--nfl-color); }
        .draft-pick-circle.NBA, .sport-badge.NBA { background-color: var(--nba-color); }
        .draft-pick-circle.MLB, .sport-badge.MLB { background-color: var(--mlb-color); }
        .draft-pick-circle.NHL, .sport-badge.NHL { background-color: var(--nhl-color); }
        .draft-pick-circle.NCAAF, .sport-badge.NCAAF { background-color: var(--ncaaf-color); }
        .draft-pick-circle.NCAAB, .sport-badge.NCAAB { background-color: var(--ncaab-color); }
        .mobile-tabs { display: none; }
        
        /* Modal & Help Icon Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: grid; place-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 20px 15px; box-sizing: border-box;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            position: relative; /* Needed for the close button */
            background: #1A1A1A; padding: 30px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1); width: 100%;
            max-width: 600px; transform: scale(0.95); transition: transform 0.3s ease;
            color: rgba(255, 255, 255, 0.85); max-height: 100%; overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; color: #fff;}
        .modal-content h4 { color: #fff; margin-bottom: 8px; margin-top: 20px;}
        .modal-content p { line-height: 1.6; margin-top: 0; margin-bottom: 1em; }
        .modal-content ul { padding-left: 20px; line-height: 1.7; }
        .modal-content li { margin-bottom: 12px; }
        .modal-content button.start-draft-button { 
            margin-top: 15px; 
            background: var(--primary);
            border: none;
            border-radius: 6px;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            color: white;
            width: 100%;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #888;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
        }
        .help-icon {
            position: absolute; top: -10px; right: 0; width: 28px; height: 28px;
            border: 1px solid #555; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 16px;
            cursor: pointer; transition: all 0.2s ease; z-index: 100;
        }
        .help-icon:hover { background: var(--primary); border-color: var(--primary); transform: scale(1.1); }
        
        .wildcard-toast {
            position: fixed;
            top: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 2000;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: top 0.5s ease-in-out;
        }
        .wildcard-toast.show {
            top: 20px;
        }
        
        /* New Style for Select Dropdown Arrow */
        .select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .select-wrapper::after {
            content: '▼';
            font-size: 12px;
            color: #aaa;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none; /* Allows clicks to pass through to the select element */
        }
        .select-wrapper select {
            width: 100%;
            box-sizing: border-box;
        }

        /* Desktop Specific Layout */
        @media (min-width: 769px) {
            .draft-container {
                grid-template-areas: "header header" "ticker sidebar" "main sidebar";
                grid-template-columns: 1fr 400px;
            }
            .mobile-tabs, .rosters-mobile-container { display: none; }
            .desktop-sidebar-area {
                display: block; grid-area: sidebar; 
                position: sticky; top: 20px;
                height: calc(100vh - 40px);
                padding: 10px 0;
            }
             .roster-container-desktop {
                background: var(--glass);
                border-radius: 12px; padding: 20px; height: 100%; overflow-y: auto;
             }
            .roster { display: none; }
            .roster.active { display: block; }
            .team-selector { margin-bottom: 15px; }
            .main-content .table-container {
                max-height: calc(100vh - 320px);
                overflow: auto;
            }
        }

        /* MOBILE RESPONSIVE STYLES */
        @media (max-width: 768px) {
            body { padding: 10px 5px; box-sizing: border-box; }
            .draft-container { grid-template-areas: "header" "sticky-header" "main"; gap: 10px; }
            .desktop-sidebar-area { display: none; }
            .site-brand { display: none; }
            .draft-header { 
                padding: 5px;
                display: flex;
                align-items: center;
                position: relative;
            }
            .league-title { 
                font-size: 1.5rem; 
                margin: 0 auto;
                padding: 0 35px; /* Symmetrical padding to avoid overlap with icon */
                overflow-wrap: break-word;
            }
            .help-icon { 
                position: absolute;
                top: 2%;
                right: 5px;
                transform: translateY(-50%);
            }
            
            .sticky-header { grid-area: sticky-header; position: sticky; top: 0; z-index: 100; background: var(--dark); padding-top: 10px; box-sizing: border-box; overflow-x: auto; max-width: 96vw; justify-content: center; }
            .draft-flow-tracker { padding: 10px; gap: 5px; flex-wrap: nowrap; align-items: center; margin-bottom: 10px;}
            .flow-pick p { font-size: 0.9rem; }
            .flow-pick.after-that { display: none; }
            .countdown-clock { font-size: 1.2rem; margin-left: 10px; padding: 5px 8px; text-align: center;}

            .filters { flex-wrap: nowrap; overflow-x: auto; scrollbar-width: none; }
            .filters::-webkit-scrollbar { display: none; }
            .filters .search-bar { min-width: 120px; } /* Reduced width */

            .mobile-tabs { display: flex; background: var(--gray); padding: 5px; border-radius: 8px; margin-bottom: 15px; }
            .mobile-tab { padding: 10px; border: none; background: none; color: white; font-size: 1rem; flex-grow: 1; border-radius: 6px; }
            .mobile-tab.active { background: var(--primary); }

            .main-content > div { display: none; }
            .main-content > div.active { display: block; }
            
            .rosters-mobile-container { padding: 10px; }
            .roster-mobile { display: block; }
            
            .draftboard-container, .teams-container {
                display: grid; grid-template-columns: 100%;
                padding: 0 5px; box-sizing: border-box;
            }
            .table-container {
                max-height: calc(100vh - 250px);
                max-width: 96vw;
                justify-content: center;
                overflow: auto;
                overflow-x: auto;
             }
            .table-container::-webkit-scrollbar { display: none; }
            .table-container { scrollbar-width: none; }

            .draft-table th { position: sticky; top: 0; z-index: 2; background: var(--dark); }
            .draft-table td:first-child, .draft-table th:first-child { position: sticky; left: 0; background: var(--dark); z-index: 1; }
            .draft-table tr:hover td:first-child { background: var(--gray); }
            .draft-table td:last-child, .draft-table th:last-child { position: sticky; right: 0; background: var(--dark); z-index: 1; }
            .draft-table tr:hover td:last-child { background: var(--gray); }
            .draft-table th:first-child, .draft-table th:last-child { z-index: 3; }
            
            .draft-table th, .draft-table td { font-size: 0.7rem; padding: 6px 8px; }
            .draft-table .sport-badge { font-size: 0.6rem; padding: 1px 5px; }
            .draft-table .team-name-cell { gap: 6px; }
            .roster li { padding-right: 4px; }
        }
    </style>
</head>
<body>
    <div class="modal-overlay" id="draftDirectionsModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="modalCloseX" style="display: none;">&times;</button>
            <h2 id="modalLeagueTitle">Welcome to the Draft!</h2>
            <p>Here’s a quick guide on how the draft room works.</p>
            
            <h4>The Draft Flow</h4>
            <p>The ticker at the top shows the previous pick, who's on the clock, and who's up next. When it's your turn, the draft buttons will become active and you'll have 2 minutes to make your selection. All other teams will auto-draft.</p>
            
            <h4>Using the Draft Board</h4>
            <ul>
                <li><strong>Find Teams:</strong> Use the search bar and filters to narrow down the list of available teams.</li>
              <ul style="margin-top: 10px;">
                <li><strong>Search Bar:</strong> Type in any part of a team’s name to instantly narrow the list.</li>
                <li><strong>Filters:</strong> Use the "Sport" dropdown to choose a sport (NFL, NBA, etc.), and the "Conference" dropdown to further refine results within that sport.</li>
                <li><strong>Combined Filtering:</strong> When a filter is selected, the search bar will only match teams within the selected filters.</li>
              </ul>
              <li><strong>Sort Data:</strong> Click any column header (like "Odds" or "ADP") to sort the table by that stat.</li>
              <li><strong>Select a Team:</strong> Click the red "Draft" button next to the team you want to add. The button will change to green and say "Confirm". Click it again to make your pick.</li>
            </ul>

            <h4>Roster Rules</h4>
            <p>You can draft a maximum of **two teams** from each of the six main sports. During **Wildcard** rounds, you can draft a team from any sport, even if you've already filled that sport's two main slots.</p>
            <p>To view rosters, use the sidebar on desktop or the "Teams" tab if you are drafting on a mobile device.</p>

            <button id="startDraftBtn" class="start-draft-button">Start Draft</button>
        </div>
    </div>

    <div class="draft-container">
        <div class="help-icon" id="helpIcon">?</div>
        <header class="draft-header">
            <div class="site-brand">Fantasy Fusion</div>
            <h1 class="league-title">League Name</h1>
        </header>

        <div class="sticky-header">
            <div class="draft-flow-tracker">
                <div class="flow-pick-container">
                    <div class="flow-pick previous"><h4>Prev Pick</h4><p id="previous-pick-info">--</p></div>
                    <div class="flow-pick on-the-clock"><h4>On The Clock</h4><p id="current-pick-info">Loading...</p></div>
                    <div class="flow-pick upcoming"><h4>Next Up</h4><p id="upcoming-pick-1">--</p></div>
                    <div class="flow-pick upcoming after-that"><h4>After That</h4><p id="upcoming-pick-2">--</p></div>
                </div>
                 <div class="countdown-clock" id="countdownClock">2:00</div>
            </div>
            <div class="draft-status-bar"><div class="draft-progress"></div></div>
            <div class="mobile-tabs">
                <button class="mobile-tab active" data-view="draftboard">Draft Board</button>
                <button class="mobile-tab" data-view="teams">Teams</button>
            </div>
        </div>
        
        <main class="main-content">
            <div class="draftboard-container active">
                 <div class="filters">
                     <div class="search-bar"><input type="text" id="teamSearch" placeholder="Search teams..."><button id="clearSearch" title="Clear">&times;</button></div>
                     <select id="sportFilter"><option value="all">All Sports</option></select>
                     <select id="conferenceFilter" disabled><option value="all">Conferences</option></select>
                     <button id="clearAllFiltersBtn" title="Clear All Filters" style="background:none; border:1px solid #555; color:#fff; border-radius:6px; padding: 0 10px; cursor:pointer; height: 38px;">Clear All</button>
                 </div>
                <div class="table-container">
                    <table class="draft-table" id="draftable-teams-table"></table>
                </div>
            </div>
            <div class="teams-container">
                 <div id="rosters-mobile"></div>
            </div>
        </main>
        <aside class="desktop-sidebar-area">
             <div class="roster-container-desktop">
                <div class="team-selector">
                    <div class="select-wrapper">
                        <select id="teamSelector" onchange="switchRoster(this.value)"></select>
                    </div>
                </div>
                <div class="roster-container" id="roster-container"></div>
             </div>
        </aside>
    
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // =================================================================================
    // DRAFT INITIALIZATION & STATE MANAGEMENT
    // =================================================================================
    const supabaseUrl = 'https://rbumhlgjljzcwaosefif.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidW1obGdqbGp6Y3dhb3NlZmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAyNTQxMTYsImV4cCI6MjA1NTgzMDExNn0.wC53zINy4iyxOzMfmqN9xw6Z2-bIjFMblXY95bS3kOQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const urlParams = new URLSearchParams(window.location.search);
    const leagueId = urlParams.get('leagueId');

    const draftState = {
        league_name: '', team_names: [], team_count: 0, wildcard_round: 0,
        user_team_name: '', current_pick: 0, draft_order: [],
        player_rosters: {}, total_picks: 0, timer: null,
        last_pick_details: null, pick_deadline: null, status: 'not_started'
    };
    let DraftableTeams = [];
    let isUserTurn = false;
    let isMobile = window.innerWidth <= 768;
    const sortState = { key: 'championship_odds', direction: 'asc' };
    let pendingDraftTeamId = null; // For 2-click draft confirmation
    let wildcardNotificationShown = false; // To show wildcard alert only once
    
    const conferenceData = {
        NFL: ["AFC", "NFC"], 
        NBA: ["East", "West"], 
        MLB: ["AL", "NL"], 
        NHL: ["East", "West"],
        NCAAF: ["AAC", "ACC", "B10", "B12", "Independent", "MAC", "MWC", "Pac-12", "SEC", "Sun Belt", "USA"],
        NCAAB: ["A-10", "AAC", "ACC", "America East", "ASUN", "B10", "B12", "Big East", "Big Sky", "Big South", "Big West", "CAA", "Horizon", "Ivy", "MAAC", "MAC", "MEAC", "MVC", "MWC", "NEC", "OVC", "Patriot", "SEC", "SoCon", "Southland", "Summit", "Sun Belt", "SWAC", "USA", "WAC", "WCC"]
    };

    // =================================================================================
    // SCRIPT ENTRY POINT
    // =================================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        if (!leagueId) {
            alert('No league ID found.');
            window.location.href = 'mock_draft_setup5.html';
            return;
        }
        showLoadingState(true);
        
        await initializeDraftState();
        
        // If draft is already completed, show final view immediately
        if (draftState.status === 'completed') {
            endDraft();
            showLoadingState(false);
            return;
        }
        
        await fetchDraftableTeamsFromDB();

        setupInitialUI();
        addEventListeners();
        showLoadingState(false);
        
        // Only show the start modal if the draft hasn't started
        if (draftState.current_pick === 0) {
            document.getElementById('draftDirectionsModal').classList.add('active');
        } else {
            // If draft is in progress, just start the logic
            checkForNextPick();
        }
    });

    // =================================================================================
    // DRAFT LOGIC & STATE
    // =================================================================================
    async function initializeDraftState() {
        try {
            const { data, error } = await supabase.from('mock_drafts').select('*').eq('id', leagueId).single();
            
            if (error) {
                throw new Error(`Database error: ${error.message}`);
            }
            if (!data) {
                throw new Error("Draft not found. Please create a new draft.");
            }
            if (!data.draft_order || !Array.isArray(data.draft_order) || data.draft_order.length === 0) {
                throw new Error("Draft data is corrupt (invalid draft order). Please create a new draft.");
            }
            
            Object.assign(draftState, data);

            const userPosition = data.user_team_position > 0 ? data.user_team_position - 1 : 0;
            draftState.user_team_name = data.team_names[userPosition] || '';
            
            if (!data.player_rosters || Object.keys(data.player_rosters).length === 0) {
                draftState.player_rosters = initializePlayerRosters(data.team_names);
            }
            
            draftState.total_picks = data.team_count * (12 + (data.wildcard_round || 0));

        } catch (err) {
            alert(err.message);
            console.error('Init Error:', err);
        }
    }
    
    async function fetchDraftableTeamsFromDB() {
        try {
            const { data, error } = await supabase.from('SportTeamDatabase_6_23_25').select('*');
            if (error) throw error;
            const pickedTeamIds = new Set(
                Object.values(draftState.player_rosters)
                      .flatMap(roster => Object.values(roster).flat())
                      .map(team => team.team_id)
            );
            DraftableTeams = data.filter(team => !pickedTeamIds.has(team.team_id));
        } catch (err) { console.error('Fetch Teams Error:', err); }
    }

    function initializePlayerRosters(teamNames) {
        const rosters = {};
        teamNames.forEach(name => {
            rosters[name] = { NFL: [], NBA: [], MLB: [], NHL: [], NCAAF: [], NCAAB: [], Wildcard: [] };
        });
        return rosters;
    }
    
    async function setPickDeadline() {
        const deadline = new Date(Date.now() + 2 * 60 * 1000).toISOString();
        draftState.pick_deadline = deadline;
        await saveDraftProgress(draftState.last_pick_details, deadline);
    }

    async function checkForNextPick() {
        if (draftState.current_pick >= draftState.total_picks) {
            endDraft();
            return;
        }

        // Wildcard round notification
        const isFirstWildcardPick = draftState.current_pick === (12 * draftState.team_count);
        if (draftState.wildcard_round > 0 && isFirstWildcardPick && !wildcardNotificationShown) {
            showWildcardNotification();
            wildcardNotificationShown = true;
        }

        updateOnTheClockUI();
        const currentDrafter = draftState.draft_order[draftState.current_pick];
        isUserTurn = currentDrafter === draftState.user_team_name;

        if (isUserTurn) {
            enableDraftButtons(true);
            const deadline = draftState.pick_deadline ? new Date(draftState.pick_deadline).getTime() : 0;
            const now = Date.now();

            if (deadline > now) {
                const remainingSeconds = Math.round((deadline - now) / 1000);
                startCountdown(remainingSeconds);
            } else {
                await setPickDeadline();
                startCountdown();
            }
        } else {
            enableDraftButtons(false);
            if (draftState.timer) clearInterval(draftState.timer);
            setTimeout(autoDraftTeam, 1500);
        }
    }

    async function draftTeam(teamId) {
        if (!isUserTurn) return;
        const team = DraftableTeams.find(t => t.team_id === teamId);
        if (!team) return;
        if (!isPickValid(team, draftState.player_rosters[draftState.user_team_name])) {
            alert(`Roster full for this sport. Please select a different team.`);
            resetPendingDraftButton();
            return;
        }
        if (draftState.timer) clearInterval(draftState.timer);
        resetPendingDraftButton();
        await processPick(team);
    }

    function autoDraftTeam() {
        const draftingTeamName = draftState.draft_order[draftState.current_pick];
        const roster = draftState.player_rosters[draftingTeamName];
        const eligibleTeams = DraftableTeams.filter(team => isPickValid(team, roster));
        
        const sortedForAI = [...eligibleTeams].sort((a, b) => {
            const oddsA = parseFloat(a.championship_odds) || Infinity;
            const oddsB = parseFloat(b.championship_odds) || Infinity;
            return oddsA - oddsB;
        });
        const teamToPick = sortedForAI.length > 0 ? sortedForAI[0] : null;

        processPick(teamToPick);
    }
    
    function isPickValid(team, roster) {
        const currentRound = Math.floor(draftState.current_pick / draftState.team_count) + 1;
        const isWildcardRound = currentRound > 12 && draftState.wildcard_round > 0;
        if (isWildcardRound) return roster.Wildcard.length < draftState.wildcard_round;
        return roster[team.sport].length < 2;
    }

    async function processPick(team) {
        const draftingTeamName = draftState.draft_order[draftState.current_pick];
        const lastPickDetailsForDB = { team: team, drafter: draftingTeamName };

        if (team) {
            const currentRound = Math.floor(draftState.current_pick / draftState.team_count) + 1;
            team.round = currentRound;
            team.pick = (draftState.current_pick % draftState.team_count) + 1;
            const sportToCredit = (currentRound > 12 && draftState.wildcard_round > 0) ? 'Wildcard' : team.sport;
            draftState.player_rosters[draftingTeamName][sportToCredit].push(team);
            DraftableTeams = DraftableTeams.filter(t => t.team_id !== team.team_id);
        }
        
        draftState.last_pick_details = lastPickDetailsForDB;
        draftState.current_pick++;
        draftState.pick_deadline = null;
        
        await saveDraftProgress(lastPickDetailsForDB, null);
        
        updateAfterPick();
        checkForNextPick();
    }

    async function saveDraftProgress(lastPickDetails, pickDeadline) {
        try {
            const isDraftComplete = draftState.current_pick >= draftState.total_picks;
            
            await supabase.from('mock_drafts').update({
                current_pick: draftState.current_pick,
                player_rosters: draftState.player_rosters,
                last_pick_details: lastPickDetails,
                pick_deadline: pickDeadline,
                status: isDraftComplete ? 'completed' : 'in_progress',
                completed_at: isDraftComplete ? new Date().toISOString() : null
            }).eq('id', leagueId);
        } catch(err) { console.error("Save Error", err); }
    }

    function endDraft() {
        if (draftState.timer) clearInterval(draftState.timer);
        alert("Draft Complete!");
        window.location.href = `mock_draft_results.html?leagueId=${leagueId}`;
    }

    // =================================================================================
    // UI & EVENT HANDLERS
    // =================================================================================
    function setupInitialUI() {
        document.querySelector('.league-title').textContent = `${draftState.league_name} Mock Draft`;
        document.getElementById('modalLeagueTitle').textContent = `Welcome to the ${draftState.league_name} Draft!`;
        updateDraftFlowTracker();
        createTeamSidebar();
        populateSportFilter();
        populateConferenceFilter();
        renderTeams();
        if (isMobile) {
            adjustUIForMobile();
            showMobileView('draftboard');
        }
    }

    function adjustUIForMobile() {
        // Shorten text for mobile filter bar
        const sportFilter = document.getElementById('sportFilter');
        if (sportFilter && sportFilter.options[0]) {
            sportFilter.options[0].textContent = "Sports";
        }
        const conferenceFilter = document.getElementById('conferenceFilter');
        if (conferenceFilter && conferenceFilter.options[0]) {
            conferenceFilter.options[0].textContent = "Conferences";
        }
        const teamSearch = document.getElementById('teamSearch');
        if (teamSearch) {
            teamSearch.placeholder = "Search";
        }
        const clearAllBtn = document.getElementById('clearAllFiltersBtn');
        if (clearAllBtn) {
            clearAllBtn.innerHTML = "&times;";
            clearAllBtn.style.color = '#aaa';
            clearAllBtn.style.fontSize = '1.5rem';
            clearAllBtn.style.padding = '0 10px';
            clearAllBtn.style.width = '38px';
            clearAllBtn.title = "Clear All Filters";
        }
    }

    function addEventListeners() {
        // Modal Listeners
        const draftModal = document.getElementById('draftDirectionsModal');
        const startDraftBtn = document.getElementById('startDraftBtn');
        const helpIcon = document.getElementById('helpIcon');
        const modalCloseX = document.getElementById('modalCloseX');

        startDraftBtn.addEventListener('click', () => {
            draftModal.classList.remove('active');
            startDraftBtn.style.display = 'none';
            modalCloseX.style.display = 'block';
            checkForNextPick();
        });
        
        const closeDraftModal = () => draftModal.classList.remove('active');
        modalCloseX.addEventListener('click', closeDraftModal);
        helpIcon.addEventListener('click', () => {
            // Re-show the modal without the start button if draft is in progress
            if(draftState.current_pick > 0){
                startDraftBtn.style.display = 'none';
                modalCloseX.style.display = 'block';
            }
            draftModal.classList.add('active');
        });

        // Filter Listeners
        document.getElementById("sportFilter").addEventListener("change", () => {
            populateConferenceFilter(); renderTeams();
        });
        document.getElementById("conferenceFilter").addEventListener("change", renderTeams);
        document.getElementById("teamSearch").addEventListener("input", () => setTimeout(renderTeams, 300));
        document.getElementById("clearSearch").addEventListener("click", () => {
            document.getElementById("teamSearch").value = ""; renderTeams();
        });
        document.getElementById('clearAllFiltersBtn').addEventListener('click', () => {
            document.getElementById("teamSearch").value = "";
            document.getElementById("sportFilter").value = "all";
            populateConferenceFilter(); 
            renderTeams();
        });
        
        // Window Listeners
        window.addEventListener('resize', () => { 
            const newIsMobile = window.innerWidth <= 768;
            if (isMobile !== newIsMobile) { window.location.reload(); }
            isMobile = newIsMobile;
        });
        document.querySelectorAll('.mobile-tab').forEach(tab => {
            tab.addEventListener('click', (e) => showMobileView(e.currentTarget.dataset.view));
        });

        // Add listener to reset pending draft button if user clicks elsewhere
        document.body.addEventListener('click', (e) => {
            if (!e.target.classList.contains('draft-button')) {
                resetPendingDraftButton();
            }
        });
    }
    
    function updateAfterPick() {
        updateDraftProgress();
        renderTeams();
        const lastDrafterName = draftState.last_pick_details?.drafter;
        if(lastDrafterName) { updateRosterDisplay(lastDrafterName); }
        if (isMobile) renderMobileRosters(document.getElementById('mobileTeamSelector')?.value);
        updateDraftFlowTracker();
    }
    
    function updateOnTheClockUI() {
        updateDraftFlowTracker();
        switchRosterToCurrentPlayer();
    }

    function updateDraftFlowTracker() {
        const { current_pick, draft_order, team_count, total_picks, last_pick_details } = draftState;
        const prevPickInfo = document.getElementById('previous-pick-info');
        if (last_pick_details) {
            if (last_pick_details.team) {
                prevPickInfo.textContent = `${last_pick_details.team.name}`;
            } else {
                 prevPickInfo.innerHTML = `<span style="opacity: 0.7;">${last_pick_details.drafter} (Skipped)</span>`;
            }
        } else {
            prevPickInfo.textContent = '--';
        }
        const currentPickInfo = document.getElementById('current-pick-info');
        if (current_pick < total_picks) {
            const teamName = draft_order[current_pick];
            const round = Math.floor(current_pick / team_count) + 1;
            const pick = (current_pick % team_count) + 1;
            
            let roundDisplay = `Round ${round}`;
            if (round > 12 && draftState.wildcard_round > 0) {
                const wildcardRoundNum = round - 12;
                roundDisplay = `Wildcard Round ${wildcardRoundNum}`;
            }

            currentPickInfo.innerHTML = `${teamName} <br> <span class="round-pick-info">${roundDisplay}, Pick ${pick}</span>`;
        } else {
            currentPickInfo.innerHTML = 'Draft Complete';
        }
        document.getElementById('upcoming-pick-1').textContent = draft_order[current_pick + 1] || '--';
        document.getElementById('upcoming-pick-2').textContent = draft_order[current_pick + 2] || '--';
    }
    
    function createTeamSidebar() {
        const rosterContainer = document.getElementById('roster-container');
        const teamSelectorParent = document.querySelector('.team-selector .select-wrapper');
        const teamSelector = document.getElementById('teamSelector');
        
        if (!rosterContainer || !teamSelectorParent || !teamSelector) return;

        rosterContainer.innerHTML = '';
        teamSelector.innerHTML = '';
        draftState.team_names.forEach(name => {
            const sanitizedId = name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
            const option = document.createElement('option');
            option.value = sanitizedId; option.textContent = name;
            teamSelector.appendChild(option);
            const rosterEl = document.createElement('div');
            rosterEl.className = 'roster';
            rosterEl.id = `roster-${sanitizedId}`;
            rosterEl.innerHTML = `<h2>${name}</h2><ul id="roster-list-${sanitizedId}"></ul>`;
            rosterContainer.appendChild(rosterEl);
            updateRosterDisplay(name);
        });
        if (rosterContainer.firstChild) rosterContainer.firstChild.classList.add('active');
    }

    function updateRosterDisplay(teamName, containerId) {
        const sanitizedId = teamName.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
        const listId = containerId || `roster-list-${sanitizedId}`;
        const rosterList = document.getElementById(listId);
        if (!rosterList) return;
        const roster = draftState.player_rosters[teamName];
        if(!roster) return; 
        let rosterHTML = '';
        const allSports = ['NFL', 'NBA', 'MLB', 'NHL', 'NCAAF', 'NCAAB'];
        allSports.forEach(sport => {
            rosterHTML += `<strong>${sport}</strong>`;
            const teams = roster[sport] || [];
            teams.forEach(t => { rosterHTML += `<li class="${t.sport}"><div class="team-icon" style="background-color:${t.primaryColor};"><i class="${getSportIcon(t)}" style="color:${t.secondaryColor};"></i></div>${t.name}<div class="draft-pick-circle ${t.sport}">${t.round}.${t.pick}</div></li>`; });
            for (let i = 0; i < (2 - teams.length); i++) rosterHTML += `<li class="empty" style="opacity: 0.4;">Empty Slot</li>`;
        });
        if (draftState.wildcard_round > 0) {
            rosterHTML += `<strong>Wildcard</strong>`;
            const wcTeams = roster.Wildcard || [];
            wcTeams.forEach(t => { rosterHTML += `<li class="${t.sport}"><div class="team-icon" style="background-color:${t.primaryColor};"><i class="${getSportIcon(t)}" style="color:${t.secondaryColor};"></i></div>${t.name}<div class="draft-pick-circle ${t.sport}">${t.round}.${t.pick}</div></li>`; });
            for (let i = 0; i < (draftState.wildcard_round - wcTeams.length); i++) rosterHTML += `<li class="empty" style="opacity: 0.4;">Empty Slot</li>`;
        }
        rosterList.innerHTML = rosterHTML;
    }
    
    function renderTeams() {
        const table = document.getElementById("draftable-teams-table");
        table.innerHTML = ''; 
        const sport = document.getElementById("sportFilter")?.value || 'all';
        const conference = document.getElementById("conferenceFilter")?.value || 'all';
        const searchQuery = document.getElementById("teamSearch")?.value.toLowerCase() || '';
        let filteredTeams = DraftableTeams.filter(t => (sport === 'all' || t.sport === sport) && (conference === 'all' || t.conference === conference) && t.name.toLowerCase().includes(searchQuery));
        const sortedTeams = sortTeams(filteredTeams);
        table.appendChild(createTableHeader());
        const tbody = document.createElement('tbody');
        sortedTeams.forEach(team => tbody.appendChild(createTeamRow(team)));
        table.appendChild(tbody);
    }
    
    function createTableHeader() {
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = [
            { key: 'name', text: 'Team' }, { key: 'championship_odds', text: 'Odds' },
            { key: 'championshipPct', text: '% Odds' }, { key: 'lastYearPoints', text: 'Prev. Pts' },
            { key: 'adp', text: 'ADP' }, { key: 'draft', text: ''}
        ];
        headers.forEach((header, index) => {
            const th = document.createElement('th');
            th.dataset.key = header.key;
            const isStickyColumn = isMobile && (index === 0 || index === headers.length - 1);
            if (isStickyColumn) {
                th.innerHTML = `<div class="sticky-cell-content"><span>${header.text}</span><span class="sort-indicator"></span></div>`;
            } else {
                th.innerHTML = `<span>${header.text}</span> <span class="sort-indicator"></span>`;
            }
            if (header.key === sortState.key) {
                th.classList.add('sort-active');
                th.querySelector('.sort-indicator').innerHTML = sortState.direction === 'asc' ? '▲' : '▼';
            }
            if(header.key !== 'draft') {
                th.addEventListener('click', handleSortClick);
            }
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        return thead;
    }

    function createTeamRow(team) {
        const row = document.createElement('tr');
        
        let oddsDisplay = 'N/A';
        if (team.championship_odds !== null && typeof team.championship_odds !== 'undefined') {
            const oddsValue = parseFloat(team.championship_odds);
            oddsDisplay = oddsValue > 0 ? `+${oddsValue}` : `${oddsValue}`;
        }

        const pctDisplay = team.championshipPct ? `${team.championshipPct.toFixed(1)}%` : 'N/A';
        const subInfo = `${team.conference || ''} ${team.division && team.division !== 'N/A' ? `| ${team.division}` : ''}`;
        const buttonHTML = `<button class="draft-button" data-team-id="${team.team_id}" onclick="event.stopPropagation(); handleDraftButtonClick(this, '${team.team_id}')">Draft</button>`;

        if (isMobile) {
            const firstCellHTML = `<td><div class="sticky-cell-content team-name-cell"><div class="team-icon" style="background-color:${team.primaryColor};"><i class="${getSportIcon(team)}" style="color:${team.secondaryColor};"></i></div><div> ${team.name} <div class="team-sub-info"><span class="sport-badge ${team.sport}">${team.sport}</span><span>${subInfo}</span></div></div></div></td>`;
            const lastCellHTML = `<td><div class="sticky-cell-content">${buttonHTML}</div></td>`;
            row.innerHTML = `${firstCellHTML}<td>${oddsDisplay}</td><td>${pctDisplay}</td><td>${team.lastYearPoints || 'N/A'}</td><td>${team.adp || 'N/A'}</td>${lastCellHTML}`;
        } else {
            row.innerHTML = `<td class="team-name-cell"><div class="team-icon" style="background-color:${team.primaryColor};"><i class="${getSportIcon(team)}" style="color:${team.secondaryColor};"></i></div><div> ${team.name} <div class="team-sub-info"><span class="sport-badge ${team.sport}">${team.sport}</span><span>${subInfo}</span></div></div></td><td>${oddsDisplay}</td><td>${pctDisplay}</td><td>${team.lastYearPoints || 'N/A'}</td><td>${team.adp || 'N/A'}</td><td>${buttonHTML}</td>`;
        }
        return row;
    }

    function handleSortClick(e) {
        const key = e.currentTarget.dataset.key;
        if (sortState.key === key) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.key = key;
            sortState.direction = (key === 'championship_odds' || key === 'adp') ? 'asc' : 'desc';
        }
        renderTeams();
    }
    
    function resetPendingDraftButton() {
        if (!pendingDraftTeamId) return;
        const pendingButton = document.querySelector(`button[data-team-id="${pendingDraftTeamId}"]`);
        if (pendingButton) {
            pendingButton.classList.remove('confirm-state');
            pendingButton.textContent = 'Draft';
        }
        pendingDraftTeamId = null;
    }

    function handleDraftButtonClick(buttonElement, teamId) {
        if (pendingDraftTeamId && pendingDraftTeamId !== teamId) {
            resetPendingDraftButton();
        }
        if (pendingDraftTeamId === teamId) {
            draftTeam(teamId);
        } else {
            pendingDraftTeamId = teamId;
            buttonElement.classList.add('confirm-state');
            buttonElement.textContent = 'Confirm';
        }
    }

    function populateSportFilter() {
        const sportFilter = document.getElementById("sportFilter");
        const sports = [...new Set(DraftableTeams.map(t => t.sport).filter(s => s))].sort();
        // Set default text that will be adjusted for mobile in adjustUIForMobile()
        sportFilter.innerHTML = `<option value="all">All Sports</option>`;
        sports.forEach(sport => sportFilter.add(new Option(sport, sport)));
    }

    function populateConferenceFilter() {
        const confFilter = document.getElementById("conferenceFilter");
        const selectedSport = document.getElementById("sportFilter").value;
        confFilter.innerHTML = `<option value="all">${isMobile ? 'Conferences' : 'All Conferences'}</option>`;
        if (selectedSport !== 'all' && conferenceData[selectedSport]) {
            confFilter.disabled = false;
            conferenceData[selectedSport].forEach(conf => confFilter.add(new Option(conf, conf)));
        } else {
            confFilter.disabled = true;
        }
    }
    
    function showWildcardNotification() {
        const toast = document.createElement('div');
        toast.className = 'wildcard-toast';
        toast.textContent = "You have started the wildcard round(s). You can now add teams from any sport to your final roster spot(s).";
        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        // Animate out and remove after a delay
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 500);
        }, 5000); // Notification stays for 5 seconds
    }

    function showMobileView(viewName) {
        document.querySelectorAll('.main-content > div').forEach(div => div.classList.remove('active'));
        document.querySelector(`.main-content .${viewName}-container`).classList.add('active');
        document.querySelectorAll('.mobile-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === viewName);
        });
        if (viewName === 'teams') {
            renderMobileRosters(document.getElementById('mobileTeamSelector')?.value || draftState.user_team_name);
        }
    }
    function renderMobileRosters(selectedTeamName = draftState.user_team_name) {
        const container = document.getElementById('rosters-mobile');
        let selectHTML = `<div class="select-wrapper"><select id="mobileTeamSelector" onchange="renderMobileRosters(this.value)">`;
        draftState.team_names.forEach(name => {
            selectHTML += `<option value="${name}" ${name === selectedTeamName ? 'selected' : ''}>${name}</option>`;
        });
        selectHTML += `</select></div>`;
        container.innerHTML = `${selectHTML}<div class="roster active"><h2>${selectedTeamName}</h2><ul id="mobile-roster-list"></ul></div>`;
        updateRosterDisplay(selectedTeamName, 'mobile-roster-list');
    }
    
    function showLoadingState(isLoading) {
        document.body.style.cursor = isLoading ? 'wait' : 'default';
        document.body.style.opacity = isLoading ? '0.5' : '1';
    }

    function sortTeams(teams) {
        const { key, direction } = sortState;
        return [...teams].sort((a,b) => {
            const valA = a[key];
            const valB = b[key];
            const dir = direction === 'asc' ? 1 : -1;
            if (key === 'name' || key === 'conference') return (valA || '').localeCompare(valB || '') * dir;
            const numA = parseFloat(valA) || (direction === 'asc' ? Infinity : -Infinity);
            const numB = parseFloat(valB) || (direction === 'asc' ? Infinity : -Infinity);
            if (numA === numB) {
                const oddsA = parseFloat(a.championship_odds) || Infinity;
                const oddsB = parseFloat(b.championship_odds) || Infinity;
                return oddsA - oddsB;
            }
            return (numA - numB) * dir;
        });
    }

    function getSportIcon(team){ const i={'NBA':'fas fa-basketball-ball','NCAAB':'fas fa-basketball-ball','NFL':'fas fa-football-ball','NCAAF':'fas fa-football-ball','MLB':'fas fa-baseball-ball','NHL':'fas fa-hockey-puck'}; return i[team.sport]||''; }
    
    function switchRosterToCurrentPlayer() {
        try {
            if (draftState.current_pick >= draftState.total_picks) return;
            const name = draftState.draft_order[draftState.current_pick];
            if (typeof name !== 'string') return;
            const sanitizedId = name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
            const sel = document.getElementById('teamSelector');
            if(sel) sel.value = sanitizedId;
            switchRoster(sanitizedId);
        } catch (err) {
            console.error("Non-critical UI error in switchRosterToCurrentPlayer:", err);
        }
    }
    
    function switchRoster(sanitizedId){document.querySelectorAll(".roster").forEach(r=>r.classList.remove('active'));const el=document.getElementById(`roster-${sanitizedId}`);if(el)el.classList.add('active');}
    function enableDraftButtons(isEnabled){document.querySelectorAll('.draft-button').forEach(b=>b.disabled=!isEnabled);}
    function startCountdown(seconds = 120){if(draftState.timer)clearInterval(draftState.timer);let timeLeft=seconds;const el=document.getElementById('countdownClock');function updateClock(){if(timeLeft<=0){clearInterval(draftState.timer);autoDraftTeam();return;}timeLeft--;const m=Math.floor(timeLeft/60);const s=timeLeft%60;el.textContent=`${m}:${String(s).padStart(2,'0')}`;};updateClock();draftState.timer=setInterval(updateClock,1000);}
    function updateDraftProgress(){const p=document.querySelector('.draft-progress');if(p){p.style.width=`${(draftState.current_pick/draftState.total_picks)*100}%`;}}

</script>
</body>
</html>
